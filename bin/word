#!/usr/bin/sh 

# CONSTANTS
card_type_name="basic"
anki_server="http://localhost:8765/"

# choosing deck
deck_name=$(curl -s "$anki_server" \
  -X POST \
  -d '{"action": "deckNames", "version": 6}' \
  | jq -r '.result[] | select(. != "Default")' \
  | dmenu -l 10 -p "Deck:")


[ -z "$deck_name" ] && exit 0

front_part=$(dmenu -p "Word: " < /dev/null)
front_part_escaped=$(printf '%s\n' "$front_part" | sed 's/"/\\"/g')
# if either of them is empty, exit 
if [ -z "$front_part_escaped" ]; then
    exit 0
fi

back_part=$(dmenu -p "Definition: " < /dev/null)
back_part_escaped=$(printf '%s\n' "$back_part" | sed 's/"/\\"/g')
# if either of them is empty, exit 
if [ -z "$back_part_escaped" ]; then
    exit 0
fi

curl $anki_server -X POST -H 'Content-Type: application/json' \
     -d '{
         "action": "addNote",
         "version": 6,
         "params": {
             "note": {
                 "deckName": "'"$deck_name"'",
                 "modelName": "'"$card_type_name"'",
                 "fields": {
                     "Front": "'"$front_part_escaped"'",
                     "Back": "'"$back_part_escaped"'"
                 },
                 "options": {
                     "allowDuplicate": false
                 }
             }
         }
     }'
